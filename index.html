<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ°è¡“å„€è¡¨æ¿ v4.1 (ç©©å®šç‰ˆ)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&display=swap');
        :root {
            --blue-team: #0984e3; --red-team: #d63031; --bg-dark: #2d3436;
            --panel-bg: #485460; --card-bg: #353b48; --text-light: #dfe6e9; 
            --text-secondary: #b2bec3; --hp-full-color: #2ecc71; --hp-mid-color: #f1c40f; 
            --hp-low-color: #e74c3c; --hp-bg: #273c75; --font-mono: 'Roboto Mono', monospace;
            --card-border-color: #3f4a59; --card-header-bg: #2a333f; --card-section-bg: #21252d;
        }        
        
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background-color: var(--bg-dark); color: var(--text-light); margin: 0; padding: 15px; }
        .dashboard { display: flex; justify-content: space-between; gap: 15px; width: 100%; height: calc(100vh - 30px); }
        .panel { background-color: var(--panel-bg); border-radius: 8px; padding: 15px; overflow-y: auto; }
        .roster-panel { flex: 2; border-top: 5px solid; }
        .roster-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--text-secondary); padding-bottom: 10px; margin-bottom: 15px; }
        .roster-header h3 { margin: 0; font-size: 1.2em; }
        .add-char-btn { background: #27ae60; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer; }
        .clear-data-btn { background: #c0392b; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer; margin-left: 10px; }
        .roster-char { position: relative; display: flex; flex-direction: column; margin-bottom: 10px; padding: 8px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; border: 1px solid transparent; }
        .roster-char.selected { background-color: rgba(255, 255, 255, 0.15); border-color: white; }
        .char-main-info { display: flex; align-items: center; width: 100%; }
        .roster-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px; border: 2px solid var(--text-secondary); }
        .delete-char-btn { position: absolute; top: 5px; right: 5px; background: #c0392b; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; opacity: 0; transition: opacity 0.2s; font-size: 12px; line-height: 20px; text-align: center; }
        .roster-char:hover .delete-char-btn { opacity: 1; }
        .hp-bar-container { width: 100%; background: var(--hp-bg); height: 8px; border-radius: 4px; margin-top: 5px; }
        .hp-bar { height: 100%; border-radius: 4px; transition: width 0.3s ease, background-color 0.3s ease; }
        .active-character-panel { flex: 4; border-top: 5px solid; }
        .active-character-panel .placeholder { text-align: center; margin-top: 40%; color: var(--text-secondary); }
        .card-layout { background: var(--card-bg); border-radius: 8px; padding: 20px; height: 100%; box-sizing: border-box; display: flex; flex-direction: column; border: 2px solid var(--card-border-color); }
        .card-header { display: flex; align-items: center; padding-bottom: 15px; margin-bottom: 15px; border-bottom: 1px solid var(--card-border-color); background-color: var(--card-header-bg); padding: 10px 15px; margin: -20px -20px 15px -20px; border-top-left-radius: 6px; border-top-right-radius: 6px; }
        .card-avatar { width: 100px; height: 100px; border-radius: 8px; object-fit: cover; margin-right: 15px; }
        .card-name-title { flex-grow: 1; }
        .card-name-title input[type=text] { width: 100%; font-size: 1.8em; font-weight: bold; background: transparent; border: none; color: inherit; padding: 2px; }
        .card-name-title input[type=text].title { font-size: 1em; font-style: italic; color: var(--text-secondary); font-weight: normal; }
        .avatar-upload-label { cursor: pointer; font-size: 0.8em; text-decoration: underline; margin-top: 5px; display: inline-block; }
        .card-stats { display: flex; justify-content: space-around; text-align: center; padding: 15px 0; margin-bottom: 15px; border-bottom: 1px solid var(--card-border-color); border-top: 1px solid var(--card-border-color); }
        .stat-box { flex: 1; position: relative; }
        .stat-box:not(:last-child)::after { content: ''; position: absolute; right: 0; top: 10%; height: 80%; width: 1px; background-color: var(--card-border-color); }
        .stat-box label { font-size: 0.8em; color: var(--text-secondary); text-transform: uppercase; }
        .stat-box .value { font-family: var(--font-mono), monospace; font-size: 2.2em; line-height: 1.1; }
        .stat-box .value input { font-family: inherit; font-size: inherit; color: inherit; background: transparent; border: none; text-align: center; width: 100%; padding: 0; }
        .card-body { padding-top: 0; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; flex-grow: 1; }
        .card-section { background-color: var(--card-section-bg); padding: 15px; border-radius: 5px; border: 1px solid var(--card-border-color); }
        .card-section h4 { margin: 0 0 10px 0; border-bottom: 1px solid var(--panel-bg); padding-bottom: 5px; }
        .item-list { list-style: none; padding: 0; }
        .item-list li { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; background: var(--bg-dark); padding: 8px; border-radius: 4px; }
        .item-remove-btn { color: #e74c3c; cursor: pointer; font-weight: bold; }
        .db-selection { display: flex; gap: 10px; margin-top: 10px; }
        .db-selection select { width: 100%; background: var(--bg-dark); color: var(--text-light); border: 1px solid var(--panel-bg); padding: 5px; border-radius: 4px; }
        .db-selection button { padding: 5px 10px; background: #27ae60; color: white; border:none; border-radius: 4px; cursor: pointer; }
        .combat-panel { flex: 3; text-align: center; display: flex; flex-direction: column; justify-content: center; }
        .combat-header { font-size: 1.5em; margin-bottom: 20px; }
        .combatants { display: flex; justify-content: space-around; align-items: center; margin-bottom: 20px; }
        .combatant { display: flex; flex-direction: column; align-items: center; }
        .combatant-avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; }
        #battle-btn { padding: 15px 40px; font-size: 1.5em; background-color: var(--red-team); color: white; border: none; border-radius: 50px; cursor: pointer; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--panel-bg); padding: 25px; border-radius: 8px; width: 90%; max-width: 500px; }
        .modal-content form { display: contents; }
        .modal-content h3 { margin-top: 0; }
        .modal-content .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .modal-content .form-group { margin-bottom: 15px; grid-column: 1 / -1; }
        .modal-content .form-grid .form-group { grid-column: auto; margin-bottom: 0; }
        .modal-content label { display: block; margin-bottom: 5px; }
        .modal-content input, .modal-content select { width: 100%; box-sizing: border-box; padding: 8px; border-radius: 5px; border: 1px solid var(--text-secondary); background: var(--bg-dark); color: var(--text-light); }
        .modal-buttons { text-align: right; margin-top: 15px; grid-column: 1 / -1; }
        .modal-buttons button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        .modal-buttons .save { background-color: #27ae60; color: white; }
        .modal-buttons .cancel { background-color: #7f8c8d; color: white; }
        .team-blue { border-color: var(--blue-team); } .team-red { border-color: var(--red-team); }
        .team-blue .roster-header h3 { color: var(--blue-team); } .team-red .roster-header h3 { color: var(--red-team); }
        .team-blue .card-name-title input[type=text] { color: var(--blue-team); } .team-red .card-name-title input[type=text] { color: var(--red-team); }
        .team-blue .avatar-upload-label { color: var(--blue-team); } .team-red .avatar-upload-label { color: var(--red-team); }
        .stat-row {
            display: flex;
            justify-content: space-around;
            width: 100%;
        }
        .card-stats {
            flex-direction: column; /* è®“å…©è¡Œæ•¸å€¼å‚ç›´æ’åˆ— */
            padding: 0;
            gap: 10px; /* å…©è¡Œä¹‹é–“çš„é–“è· */
        }
        .proficiency-row {
            border-top: 1px solid var(--card-border-color);
            padding-top: 10px;
        }
        .proficiency-row .value {
            font-size: 1.8em; /* è®“ç¬¬äºŒè¡Œçš„å­—å°ä¸€é»ï¼Œä»¥ç¤ºå€åˆ¥ */
        }
        .passive-skill-section {
            margin-top: 15px; /* èˆ‡ä¸Šæ–¹å€å¡Šçš„é–“è· */
        }
        .passive-skill-box {
            background: var(--bg-dark);
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .skill-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
        .skill-actions {
          display: flex;
          align-items: center;
          gap: 8px;
          flex-shrink: 0; /* é˜²æ­¢æŒ‰éˆ•è¢«å£“ç¸® */
      }
        .skill-use-btn {
          padding: 5px 10px;
          background-color: var(--blue-team);
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
      }
        .skill-use-btn:disabled {
          background-color: var(--text-secondary);
          cursor: not-allowed;
      }
    </style>
</head>
<body>
    <div id="loading-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); color: white; display: flex; justify-content: center; align-items: center; z-index: 2000; font-size: 1.5em;">
        æ­£åœ¨å¾ Google Sheets è¼‰å…¥éŠæˆ²è¦å‰‡...
    </div>
    <div class="dashboard">
        <div class="panel roster-panel team-blue"><div class="roster-header"><h3>è—æ–¹äººå“¡åˆ—è¡¨</h3><div><button class="add-char-btn" onclick="openAddCharModal('blue')">æ–°å¢</button><button class="clear-data-btn" onclick="clearTeamData('blue')">æ¸…é™¤è—æ–¹</button></div></div><div id="roster-blue"></div></div>
        <div class="panel active-character-panel team-blue" id="active-panel-blue"><div class="placeholder">è«‹æ–°å¢æˆ–é¸æ“‡è§’è‰²</div></div>
        <div class="panel combat-panel" id="combat-panel"><h2 class="combat-header">äº¤æˆ°æ¨¡æ“¬</h2><div class="combatants"><div class="combatant"><img id="combatant-avatar-blue" src="https://placehold.co/80x80?text=?" class="combatant-avatar"><h3 id="combatant-name-blue">é¸æ“‡è—æ–¹</h3></div><div> VS </div><div class="combatant"><img id="combatant-avatar-red" src="https://placehold.co/80x80?text=?" class="combatant-avatar"><h3 id="combatant-name-red">é¸æ“‡ç´…æ–¹</h3></div></div><div class="combat-options" style="margin-bottom: 20px;"><div class="form-group" style="margin-bottom:10px;"><label for="attack-angle">æ”»æ“Šè§’åº¦</label><select id="attack-angle" style="padding: 8px; width: 150px; margin:auto;"><option value="front">å‰æ–¹</option><option value="side">å´é¢</option><option value="rear">å¾Œæ–¹</option></select></div></div><button id="battle-btn" onclick="simulateCombat()">é–‹å§‹æˆ°é¬¥</button><div id="combat-log" style="margin-top: 20px; text-align: left; background: var(--bg-dark); padding: 10px; border-radius: 5px; max-height: 300px; overflow-y: auto;"><strong>æˆ°é¬¥è¨˜éŒ„:</strong></div></div>
        <div class="panel active-character-panel team-red" id="active-panel-red"><div class="placeholder">è«‹æ–°å¢æˆ–é¸æ“‡è§’è‰²</div></div>
        <div class="panel roster-panel team-red"><div class="roster-header"><h3>ç´…æ–¹äººå“¡åˆ—è¡¨</h3><div><button class="add-char-btn" onclick="openAddCharModal('red')">æ–°å¢</button><button class="clear-data-btn" onclick="clearTeamData('red')">æ¸…é™¤ç´…æ–¹</button></div></div><div id="roster-red"></div></div>
    </div>
    <div id="addCharModal" class="modal">
        <div class="modal-content"><form id="addCharForm"><h3 id="modalTitle">æ–°å¢è§’è‰²</h3>
<div class="form-group">
    <label for="charIdTemplate">è³‡æ–™åº«ID (é¸å¡«ï¼Œå¯è‡ªå‹•å¸¶å…¥è³‡è¨Š)</label>
    <input type="text" id="charIdTemplate" placeholder="ä¾‹å¦‚ï¼šspec_ops_01">
</div>
            <div class="form-group"><label for="charName">è§’è‰²åç¨±</label><input type="text" id="charName" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜"></div><div class="form-group"><label for="charTitle">ç¨±è™Ÿ</label><input type="text" id="charTitle" placeholder="ä¾‹å¦‚ï¼šè·¯äººç”²"></div><div class="form-grid">
    <div class="form-group"><label for="charMobility">æ©Ÿå‹• (MOVE)</label><input type="number" id="charMobility" value="5"></div>
    <div class="form-group"><label for="charStrength">è‚ŒåŠ› (STR)</label><input type="number" id="charStrength" value="15"></div>
    <div class="form-group"><label for="charPrimaryProf">ä¸»æ­¦å™¨ç†Ÿç¨”</label>
        <select id="charPrimaryProf">
            <option value="S">S</option><option value="A">A</option><option value="B" selected>B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option>
        </select>
    </div>
    <div class="form-group"><label for="charSecondaryProf">å‰¯æ­¦å™¨ç†Ÿç¨”</label>
         <select id="charSecondaryProf">
            <option value="S">S</option><option value="A">A</option><option value="B">B</option><option value="C" selected>C</option><option value="D">D</option><option value="E">E</option>
        </select>
    </div>
    <div class="form-group"><label for="charBreachingProf">ç ´é–€å·¥å…·ç†Ÿç¨”</label>
         <select id="charBreachingProf">
            <option value="S">S</option><option value="A">A</option><option value="B">B</option><option value="C" selected>C</option><option value="D">D</option><option value="E">E</option>
        </select>
    </div>
    <div class="form-group"><label for="charSpecialProf">ç‰¹æ®Šè£å‚™ç†Ÿç¨”</label>
         <select id="charSpecialProf">
            <option value="S">S</option><option value="A">A</option><option value="B">B</option><option value="C" selected>C</option><option value="D">D</option><option value="E">E</option>
        </select>
    </div>
</div>
    <div class="modal-buttons"><button type="button" class="cancel" onclick="close()">å–æ¶ˆ</button><button type="submit" class="save" id="saveCharBtn">å„²å­˜</button></div></form></div>
    </div>

    <script>
    // --- Databases (will be populated from Google Sheets) ---
    let WEAPON_DB = {};
    let GEAR_DB = {};
    let SKILL_DB = {};
    let characterTemplateDB = {};

    const PROFICIENCY_MODIFIERS = { 'S': 1.05, 'A': 1.0, 'B': 0.95, 'C': 0.9, 'D': 0.85, 'E': 0.8 };
    
    // --- Application State ---
    let gameState = { characters: { blue: [], red: [] }, selectedChar: { blue: null, red: null }, combatants: { blue: null, red: null } };

    // --- Core Functions ---
    async function fetchAllGameData() {
        const loadingOverlay = document.getElementById('loading-overlay');
        loadingOverlay.textContent = 'æ­£åœ¨å¾ Google Sheets è¼‰å…¥éŠæˆ²è¦å‰‡...';
        loadingOverlay.style.display = 'flex';

        const urls = {
            // !!! è«‹å‹™å¿…å°‡ä¸‹æ–¹å››å€‹ç¶²å€æ›¿æ›ç‚ºæ‚¨è‡ªå·±çš„ Google Sheet CSV ç™¼ä½ˆç¶²å€ !!!
            characters: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTQyn3ID7LBfpRjYBuX1mLweeQ1sr7thV4WHMiG5AqiqURFJftxuJ2z_8XXNPL8yIt7avYq8xfmPv09/pub?gid=0&single=true&output=csv',
            weapons: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSUgRC-c-_jUmGAF6CJn3P057w0bc43uWBTnmPbEVUSSPa4GlWqudaM7HY3Oc_NIgI9L_mPEai3weRS/pub?gid=619091591&single=true&output=csv',
            gear: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRhpFeTps4MlzO_sRZbABh_YhjmNngDRfYUjoyfJm7KqEemObopE9RQ_V30C8ZWgvclRBUuqcU5BVOI/pub?gid=2032212675&single=true&output=csv',
            skills: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTW3fGuzaVQXHxPg32SG3qhUBmuL_uJTTEqx8HrcT7ZtQVmIN6623OR5bZPooGiizHOIEAEoBQQkHCl/pub?gid=1620707329&single=true&output=csv'
        };

        try {
            const responses = await Promise.all([
                fetch(urls.characters).then(res => res.text()), fetch(urls.weapons).then(res => res.text()),
                fetch(urls.gear).then(res => res.text()), fetch(urls.skills).then(res => res.text())
            ]);
            const [charCsv, weaponCsv, gearCsv, skillCsv] = responses;

            // Simple Parsing Logic
            characterTemplateDB = {};
            const charRows = charCsv.split('\n').slice(1);
            charRows.forEach((row, index) => {
                if (!row.trim()) return;
                const cols = row.trim().split(',');
                if (cols.length < 10) throw new Error(`ç¬¬ ${index + 2} è¡Œæ¬„ä½æ•¸ä¸è¶³ (æ‡‰ç‚º10ï¼Œå¯¦éš›ç‚º${cols.length})`);
                const t = { 
                    id: cols[0], name: cols[1], title: cols[2], 
                    stats: { mobility: parseInt(cols[3]), strength: parseInt(cols[4]) }, 
                    primary_proficiency: cols[5], 
                    secondary_proficiency: cols[6],
                    breaching_proficiency: cols[7],
                    special_proficiency: cols[8],
                    passive_skill_id: cols[9].trim()
                };
                characterTemplateDB[t.id] = t;
            });
            WEAPON_DB = {};
            weaponCsv.split('\n').slice(1).forEach(row => {
                if (!row.trim()) return; const cols = row.trim().split(','); if (cols.length < 9) return;
                const effectsString = cols[9] ? cols[9].trim() : '[]';
                WEAPON_DB[cols[0]] = { name: cols[1], weight: parseInt(cols[2]), type: cols[3], ammo_type: cols[4], base_damage: parseInt(cols[5]), accuracy_short: parseInt(cols[6]), accuracy_mid: parseInt(cols[7]), accuracy_long: parseInt(cols[8]), effects: JSON.parse(effectsString) };
            });
            GEAR_DB = {};
            gearCsv.split('\n').slice(1).forEach(row => {
                if (!row.trim()) return; const cols = row.trim().split(','); if (cols.length < 10) return;
                const effectsString = cols[10] ? cols[10].trim() : '[]';
                GEAR_DB[cols[0]] = { name: cols[1], weight: parseInt(cols[2]), gear_type: cols[3], mobility_penalty: parseInt(cols[4]), coverage_front: parseInt(cols[5]), coverage_side: parseInt(cols[6]), coverage_rear: parseInt(cols[7]), durability: parseInt(cols[8]), armor_level: cols[9], effects: JSON.parse(effectsString) };
            });
            SKILL_DB = {};
            const skillRows = skillCsv.split('\n').slice(1);
            skillRows.forEach((row, index) => {
                if (!row.trim()) return;
                const cols = row.trim().split(',');
                if (cols.length < 5) throw new Error(`ç¬¬ ${index + 2} è¡Œæ¬„ä½æ•¸ä¸è¶³ (æ‡‰è‡³å°‘5æ¬„)`);
                const effectsString = cols[5] ? cols[5].trim() : '[]';
                SKILL_DB[cols[0]] = { 
                    name: cols[1], 
                    type: cols[2], 
                    desc: cols[3], 
                    uses: parseInt(cols[4]), 
                    effects: JSON.parse(effectsString) 
                };
            });

            console.log('æ‰€æœ‰éŠæˆ²è³‡æ–™å·²æˆåŠŸè¼‰å…¥ï¼');
            loadingOverlay.style.display = 'none';
        } catch (error) {
            console.error('è¼‰å…¥æˆ–è§£æéŠæˆ²è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            loadingOverlay.textContent = `è¼‰å…¥å¤±æ•—ï¼è«‹æŒ‰F12æª¢æŸ¥ä¸»æ§å°éŒ¯èª¤è¨Šæ¯ã€‚`;
        }
    }
    
    function saveData() { localStorage.setItem('tacticalDashboardData_v4.1', JSON.stringify(gameState.characters)); }
    function loadData() {
        const data = localStorage.getItem('tacticalDashboardData_v4.1');
        if (data) gameState.characters = JSON.parse(data);
    }
    function clearTeamData(team) { const teamName = team === 'blue' ? 'è—æ–¹' : 'ç´…æ–¹'; if (confirm(`ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰${teamName}çš„è§’è‰²è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) { gameState.characters[team] = []; gameState.selectedChar[team] = null; gameState.combatants[team] = null; saveData(); renderAll(); } }
    function renderAll() { ['blue', 'red'].forEach(team => { renderRoster(team); const selectedId = gameState.selectedChar[team]; if (selectedId && gameState.characters[team].some(c => c.id === selectedId)) { displayCharacterDetails(selectedId, team); } else if (gameState.characters[team].length > 0) { gameState.selectedChar[team] = gameState.characters[team][0].id; renderRoster(team); displayCharacterDetails(gameState.selectedChar[team], team); } else { document.getElementById(`active-panel-${team}`).innerHTML = `<div class="placeholder">è«‹æ–°å¢æˆ–é¸æ“‡è§’è‰²</div>`; } }); updateCombatPanel(); }
    function renderRoster(team) { const rosterContainer = document.getElementById(`roster-${team}`); rosterContainer.innerHTML = ''; gameState.characters[team].forEach(char => { const charDiv = document.createElement('div'); charDiv.className = 'roster-char'; if (gameState.selectedChar[team] === char.id) charDiv.classList.add('selected'); charDiv.onclick = () => { gameState.selectedChar[team] = char.id; renderAll(); }; const hpPercent = (char.currentHP / 100) * 100; let hpBarColor = `var(--hp-full-color)`; if (hpPercent < 70) hpBarColor = `var(--hp-mid-color)`; if (hpPercent < 30) hpBarColor = `var(--hp-low-color)`; charDiv.innerHTML = ` <div class="char-main-info"> <img src="${char.avatar}" class="roster-avatar"> <span>${char.name}</span> </div> <div class="hp-bar-container"><div class="hp-bar" style="width: ${hpPercent}%; background-color: ${hpBarColor};"></div></div> <button class="delete-char-btn" onclick="event.stopPropagation(); deleteCharacter('${char.id}', '${team}')">âœ•</button> `; rosterContainer.appendChild(charDiv); }); }
    function addCharacter(team, event) {
    event.preventDefault();
    const templateId = document.getElementById('charIdTemplate').value;
    const template = characterTemplateDB[templateId]; 
        
    const newChar = {
        id: 'char_' + Date.now(),
        name: document.getElementById('charName').value || 'æ–°å…µ',
        title: document.getElementById('charTitle').value || 'ç„¡åå°å’',
        maxHP: 100, 
        currentHP: 100,
        stats: {
            mobility: parseInt(document.getElementById('charMobility').value) || 5,
            strength: parseInt(document.getElementById('charStrength').value) || 15,
        },
        primary_proficiency: document.getElementById('charPrimaryProf').value,
        secondary_proficiency: document.getElementById('charSecondaryProf').value,
        breaching_proficiency: document.getElementById('charBreachingProf').value,
        special_proficiency: document.getElementById('charSpecialProf').value,
        passive_skill_id: template ? template.passive_skill_id : null, 
        avatar: 'https://placehold.co/100x100?text=?', 
        equipment: [], 
        skills: [], 
        skillCharges: {} 
    };
    
    gameState.characters[team].push(newChar);
    gameState.selectedChar[team] = newChar.id;
    closeAddCharModal(); 
    saveData(); 
    renderAll();
}
    function deleteCharacter(charId, team) { if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è§’è‰²å—ï¼Ÿ')) return; const index = gameState.characters[team].findIndex(c => c.id === charId); if (index > -1) { gameState.characters[team].splice(index, 1); if(gameState.selectedChar[team] === charId) gameState.selectedChar[team] = null; if(gameState.combatants[team] === charId) gameState.combatants[team] = null; saveData(); renderAll(); } }
    function displayCharacterDetails(charId, team) {
    const char = gameState.characters[team].find(c => c.id === charId);
    const panel = document.getElementById(`active-panel-${team}`);
    if (!char) { panel.innerHTML = `<div class="placeholder">è§’è‰²ä¸å­˜åœ¨</div>`; return; }

    let totalWeight = 0;
    char.equipment.forEach(itemId => { const item = WEAPON_DB[itemId] || GEAR_DB[itemId]; if (item) totalWeight += item.weight; });
    
    const activeSkillOptions = Object.keys(SKILL_DB).filter(id => SKILL_DB[id].type === 'active').map(id => `<option value="${id}">${SKILL_DB[id].name}</option>`).join('');
    const weaponOptions = Object.keys(WEAPON_DB).map(id => `<option value="${id}">${WEAPON_DB[id].name}</option>`).join('');
    const gearOptions = Object.keys(GEAR_DB).map(id => `<option value="${id}">${GEAR_DB[id].name}</option>`).join('');
    
    const passiveSkill = SKILL_DB[char.passive_skill_id];
    let passiveSkillHTML = `<h4>å›ºæœ‰è¢«å‹•æŠ€èƒ½ (Passive)</h4><div class="passive-skill-box">ç„¡</div>`;
    if (passiveSkill) {
        passiveSkillHTML = `
            <h4>å›ºæœ‰è¢«å‹•æŠ€èƒ½ (Passive)</h4>
            <div class="passive-skill-box">
                <strong>${passiveSkill.name}</strong><br>
                <small style="color: var(--text-secondary);">${passiveSkill.desc}</small>
            </div>
        `;
    }
    
    // ã€æ–°å¢ã€‘æª¢æŸ¥ä¸»å‹•æŠ€èƒ½æ•¸é‡æ˜¯å¦å·²é”ä¸Šé™
    const isSkillSlotFull = char.skills.length >= 2;

    panel.innerHTML = `
        <div class="card-layout">
            <div class="card-header">
                <img src="${char.avatar}" class="card-avatar" id="avatar-${team}-${charId}">
                <div class="card-name-title">
                    <input type="text" value="${char.name}" onchange="updateCharValue('${char.id}', '${team}', 'name', this.value)">
                    <input type="text" class="title" value="${char.title}" onchange="updateCharValue('${char.id}', '${team}', 'title', this.value)">
                    <label class="avatar-upload-label">æ›´æ›é ­åƒ <input type="file" onchange="handleAvatarUpload(event, '${char.id}', '${team}')" accept="image/*" style="display:none;"></label>
                </div>
            </div>
            <div class="card-stats">
                <div class="stat-row"><div class="stat-box"> <label>HP</label> <div class="value"><input type="number" value="${char.currentHP}" onchange="updateCharValue('${char.id}', '${team}', 'currentHP', this.value)"></div> </div><div class="stat-box"> <label>MOVE</label> <div class="value">${char.stats.mobility}</div> </div><div class="stat-box"> <label>STRENGTH</label> <div class="value">${char.stats.strength}</div> </div><div class="stat-box"> <label>WEIGHT</label> <div class="value">${totalWeight}</div> </div></div>
                <div class="stat-row proficiency-row"><div class="stat-box"> <label>PRIMARY</label> <div class="value">${char.primary_proficiency}</div> </div><div class="stat-box"> <label>SECONDARY</label> <div class="value">${char.secondary_proficiency}</div> </div><div class="stat-box"> <label>BREACHING</label> <div class="value">${char.breaching_proficiency}</div> </div><div class="stat-box"> <label>SPECIAL</label> <div class="value">${char.special_proficiency}</div> </div></div>
            </div>
            <div class="card-body">
                <div class="card-section">
                    <h4>è£å‚™ (Equipment)</h4>
                    <ul class="item-list">${char.equipment.map(id => { const item = WEAPON_DB[id] || GEAR_DB[id]; if(!item) return ''; return `<li><div><strong>${item.name}</strong> (+${item.weight} WU)${formatEffects(item)}</div><span class="item-remove-btn" onclick="removeItem('${char.id}','${team}','equipment','${id}')">âœ•</span></li>`; }).join('')}</ul>
                    <div class="db-selection"> <select id="equip-select-${team}"><optgroup label="æ­¦å™¨">${weaponOptions}</optgroup><optgroup label="é…ä»¶">${gearOptions}</optgroup></select> <button onclick="addItem('${char.id}','${team}','equipment','equip-select-${team}')">æ·»åŠ </button> </div>
                </div>
                <div class="card-section">
                    <h4>ä¸»å‹•æŠ€èƒ½ (Active)</h4>
                    <ul class="item-list">
                        ${char.skills.map(id => {
                            const skill = SKILL_DB[id];
                            if (!skill) return '';
                            if (char.skillCharges[id] === undefined) { char.skillCharges[id] = skill.uses; }
                            const remainingUses = char.skillCharges[id];
                            const buttonDisabled = remainingUses <= 0 ? 'disabled' : '';
                            return `
                                <li class="skill-item">
                                    <div>
                                        <strong>${skill.name}</strong><br>
                                        <small style="color: var(--text-secondary);">${skill.desc}</small>
                                    </div>
                                    <div class="skill-actions">
                                        <span class="skill-uses">(${remainingUses}/${skill.uses})</span>
                                        <button class="skill-use-btn" onclick="activateSkill('${char.id}', '${team}', '${id}')" ${buttonDisabled}>ä½¿ç”¨</button>
                                        <span class="item-remove-btn" onclick="removeItem('${char.id}','${team}','skills','${id}')">âœ•</span>
                                    </div>
                                </li>`;
                        }).join('')}
                    </ul>
                    <div class="db-selection">
                        <select id="skill-select-${team}" ${isSkillSlotFull ? 'disabled' : ''}>${activeSkillOptions}</select>
                        <button onclick="addItem('${char.id}','${team}','skills','skill-select-${team}')" ${isSkillSlotFull ? 'disabled' : ''}>æ·»åŠ </button>
                    </div>
                </div>
            </div>
            <div class="card-section passive-skill-section">
                ${passiveSkillHTML}
            </div>
            <div style="text-align: center; margin-top: auto;"><button class="add-char-btn" onclick="selectCombatant('${char.id}', '${team}')">é¸ç‚ºæˆ°é¬¥å–®ä½</button></div>
        </div>
    `;
}
    function handleAvatarUpload(event, charId, team) { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { const char = gameState.characters[team].find(c => c.id === charId); if (char) { char.avatar = e.target.result; saveData(); renderAll(); } }; reader.readAsDataURL(file); } }
    function updateCharValue(charId, team, key, value) { const char = gameState.characters[team].find(c => c.id === charId); if (!char) return; const keys = key.split('.'); let obj = char; for (let i = 0; i < keys.length - 1; i++) { obj = obj[keys[i]]; } let finalValue = typeof obj[keys[keys.length - 1]] === 'number' ? parseInt(value) : value; obj[keys[keys.length - 1]] = finalValue; if (key === 'currentHP') { if (char.currentHP > 100) char.currentHP = 100; if (char.currentHP < 0) char.currentHP = 0; } saveData(); renderAll(); }
    function addItem(charId, team, itemType, selectId) {
    const char = gameState.characters[team].find(c => c.id === charId);
    if (!char) return;

    // ã€æ–°å¢ã€‘æª¢æŸ¥æŠ€èƒ½æ•¸é‡ä¸Šé™
    if (itemType === 'skills' && char.skills.length >= 2) {
        alert('ä¸»å‹•æŠ€èƒ½æœ€å¤šåªèƒ½é¸æ“‡å…©å€‹ï¼');
        return; // ä¸­æ–·å‡½å¼åŸ·è¡Œ
    }

    const select = document.getElementById(selectId);
    const itemId = select.value;
    if (char && !char[itemType].includes(itemId)) {
        char[itemType].push(itemId);
        saveData();
        renderAll();
    }
}
    function removeItem(charId, team, itemType, itemId) { const char = gameState.characters[team].find(c => c.id === charId); if (char) { const index = char[itemType].indexOf(itemId); if (index > -1) { char[itemType].splice(index, 1); saveData(); renderAll(); } } }
    function openAddCharModal(team) {
    const modal = document.getElementById('addCharModal');
    const form = document.getElementById('addCharForm');
    form.reset();
    modal.style.display = 'flex';
    document.getElementById('modalTitle').textContent = `æ–°å¢ ${team === 'blue' ? 'è—æ–¹' : 'ç´…æ–¹'} è§’è‰²`;

    const idInput = document.getElementById('charIdTemplate');
    
    // ç•¶ ID è¼¸å…¥æ¡†å¤±å»ç„¦é»æ™‚è§¸ç™¼
    idInput.onblur = () => {
        const enteredId = idInput.value;
        const template = characterTemplateDB[enteredId];
        
        if (template) {
            // å¦‚æœåœ¨è³‡æ–™åº«ä¸­æ‰¾åˆ°è©²è§’è‰²ï¼Œè‡ªå‹•å¡«å…¥æ‰€æœ‰ç›¸é—œæ¬„ä½
            document.getElementById('charName').value = template.name;
            document.getElementById('charTitle').value = template.title;
            document.getElementById('charMobility').value = template.stats.mobility;
            document.getElementById('charStrength').value = template.stats.strength;
            document.getElementById('charPrimaryProf').value = template.primary_proficiency;
            document.getElementById('charSecondaryProf').value = template.secondary_proficiency;
            document.getElementById('charBreachingProf').value = template.breaching_proficiency;
            document.getElementById('charSpecialProf').value = template.special_proficiency;
        }
    };
    
    form.onsubmit = (event) => addCharacter(team, event);
}
    function closeAddCharModal() { document.getElementById('addCharModal').style.display = 'none'; }
    function formatEffects(item) { if (!item.effects || item.effects.length === 0) return ''; const effectStrings = item.effects.map(effect => { if (effect.stat) { let statName = effect.stat; if (statName === 'maxHP') statName = 'æœ€å¤§HP'; if (statName === 'mobility') statName = 'æ©Ÿå‹•'; if (statName === 'strength_calculation') statName = 'è‚ŒåŠ›(è¨ˆç®—ç”¨)'; if (statName === 'accuracy_short') statName = 'è¿‘è·é›¢å‘½ä¸­'; if (statName === 'crit_chance') statName = 'æš´æ“Šç‡'; if (statName === 'crit_damage') statName = 'æš´æ“Šå‚·å®³'; return `${statName} ${effect.modifier}${effect.value}`; } if (effect.effect === 'apply_status') { return `æœ‰ ${effect.chance * 100}% æ©Ÿç‡é™„åŠ ã€${effect.status}ã€‘ç‹€æ…‹`; } return 'ç‰¹æ®Šæ•ˆæœ'; }); return `<br><small style="color: var(--text-secondary);">æ•ˆæœ: ${effectStrings.join(' / ')}</small>`; }
    function selectCombatant(charId, team) { const char = gameState.characters[team].find(c => c.id === charId); if (char) { gameState.combatants[team] = charId; updateCombatPanel(); } }
    function updateCombatPanel() { const blueChar = gameState.characters['blue'].find(c => c.id === gameState.combatants['blue']); const redChar = gameState.characters['red'].find(c => c.id === gameState.combatants['red']); document.getElementById('combatant-name-blue').textContent = blueChar ? blueChar.name : 'é¸æ“‡è—æ–¹'; document.getElementById('combatant-avatar-blue').src = blueChar ? blueChar.avatar : 'https://placehold.co/80x80?text=?'; document.getElementById('combatant-name-red').textContent = redChar ? redChar.name : 'é¸æ“‡ç´…æ–¹'; document.getElementById('combatant-avatar-red').src = redChar ? redChar.avatar : 'https://placehold.co/80x80?text=?'; }
    function activateSkill(charId, team, skillId) {
    const char = gameState.characters[team].find(c => c.id === charId);
    const skill = SKILL_DB[skillId];
    if (!char || !skill || char.skillCharges[skillId] <= 0) {
        return; 
    }

    char.skillCharges[skillId]--;

    console.log(`è§’è‰² ${char.name} ä½¿ç”¨äº†æŠ€èƒ½ [${skill.name}]ï¼`);
    console.log("æŠ€èƒ½æ•ˆæœ (effects):", skill.effects);
    console.log("ä¸‹ä¸€æ­¥ï¼šæˆ‘å€‘éœ€è¦åœ¨ simulateCombat ä¸­åŠ å…¥é‚è¼¯ä¾†å¯¦éš›å¥—ç”¨é€™äº›æ•ˆæœã€‚");
    
    saveData();
    renderAll();
}
    function simulateCombat() { const blueChar = gameState.characters['blue'].find(c => c.id === gameState.combatants['blue']); const redChar = gameState.characters['red'].find(c => c.id === gameState.combatants['red']); const combatLog = document.getElementById('combat-log'); combatLog.innerHTML = '<strong>æˆ°é¬¥è¨˜éŒ„:</strong><br>'; if (!blueChar || !redChar) { combatLog.innerHTML += `<p style="color:red;">è«‹ç¢ºä¿é›™æ–¹éƒ½å·²é¸æ“‡æˆ°é¬¥å–®ä½ï¼</p>`; return; } const log = (message) => { combatLog.innerHTML += `<p>${message}</p>`; combatLog.scrollTop = combatLog.scrollHeight;}; log(`>>> ${blueChar.name} å° ${redChar.name} ç™¼å‹•æ”»æ“Šï¼`); const weapon = blueChar.equipment.map(id => WEAPON_DB[id]).find(item => item && item.type === 'primary'); if (!weapon) { log(`âŒ ${blueChar.name} æ²’æœ‰è£å‚™ä¸»æ­¦å™¨ï¼`); return; } const proficiencyKey = weapon.type === 'primary' ? 'primary_proficiency' : 'secondary_proficiency'; const proficiencyLevel = blueChar[proficiencyKey] || 'E'; const proficiencyMod = PROFICIENCY_MODIFIERS[proficiencyLevel] || 0.8; let baseAccuracy = weapon.accuracy_mid; let finalBaseDamage = weapon.base_damage * proficiencyMod; log(`æ­¦å™¨ç†Ÿç¨”åº¦(${proficiencyLevel}): æ•ˆç‡ ${proficiencyMod * 100}%`); let passiveBonuses = { accuracy: 0, damage: 0, crit_chance: 0, crit_damage: 0 }; blueChar.equipment.forEach(id => { const item = GEAR_DB[id]; if (item && item.effects) { item.effects.forEach(effect => { if(effect.stat && effect.stat.includes('accuracy')) { passiveBonuses.accuracy += effect.value; log(`âš¡ ä¾†è‡ª [${item.name}] çš„åŠ æˆ: å‘½ä¸­ +${effect.value}`); } }); } }); const finalBaseAccuracy = (baseAccuracy + passiveBonuses.accuracy) * proficiencyMod; const finalHitChance = finalBaseAccuracy; const hitRoll = Math.floor(Math.random() * 100) + 1; log(`æ“²éª°åˆ¤å®šå‘½ä¸­ (d100 <= ${finalHitChance.toFixed(0)})... çµæœ: ${hitRoll}`); if (hitRoll > finalHitChance) { log(`ğŸ’¥ MISS!! æ”»æ“Šå¤±æ‰‹ï¼`); return; } log(`âœ”ï¸ åˆæ­¥å‘½ä¸­ï¼é€²å…¥è­·ç”²åˆ¤å®š...`); const attackAngle = document.getElementById('attack-angle').value; const coverageKey = `coverage_${attackAngle}`; let highestCoverage = 0, blockingArmorId = null; redChar.equipment.forEach(id => { const item = GEAR_DB[id]; if (item && (item.gear_type === 'armor' || item.gear_type === 'shield') && item[coverageKey] > highestCoverage) { highestCoverage = item[coverageKey]; blockingArmorId = id; } }); if (highestCoverage > 0) { const blockRoll = Math.floor(Math.random() * 100) + 1; log(`é˜²ç¦¦æ–¹ ${attackAngle} æ–¹å‘é˜²ç¦¦ç‡ç‚º ${highestCoverage}%`); log(`æ“²éª°åˆ¤å®šæ ¼æ“‹ (d100 <= ${highestCoverage})... çµæœ: ${blockRoll}`); if (blockRoll <= highestCoverage) { const blockingArmor = GEAR_DB[blockingArmorId]; log(`ğŸ›¡ï¸ è¢«æ“‹ä¸‹äº†!! æ”»æ“Šè¢« ${blockingArmor.name} é˜»æ“‹ï¼`); blockingArmor.durability -= 1; log(`${blockingArmor.name} è€ä¹…åº¦å‰©é¤˜ ${blockingArmor.durability}`); if(blockingArmor.durability <= 0) log(`âš ï¸ ${blockingArmor.name} å·²å¤±æ•ˆï¼`); saveData(); renderAll(); return; } } log(`ğŸ©¸ æ”»æ“Šç©¿é€é˜²ç¦¦ï¼Œå‘½ä¸­è‚‰èº«ï¼`); const variance = (Math.random() * 0.10) - 0.05; let damage = finalBaseDamage * (1 + variance); log(`è¨ˆç®—åŸºç¤å‚·å®³... ${finalBaseDamage.toFixed(1)} * (1 ${variance > 0 ? '+' : ''} ${variance.toFixed(2)}) = ${damage.toFixed(1)}`); const critChance = 5 + passiveBonuses.crit_chance; const critRoll = Math.floor(Math.random() * 100) + 1; log(`æ“²éª°åˆ¤å®šæš´æ“Š (d100 >= ${101 - critChance})... çµæœ: ${critRoll}`); if (critRoll >= (101 - critChance)) { const critBonus = 0.05 + (passiveBonuses.crit_damage / 100); const extraDamage = damage * critBonus; damage += extraDamage; log(`ğŸ’¥ CRITICAL HIT!! é¡å¤–é€ æˆ ${extraDamage.toFixed(1)} å‚·å®³ï¼`); } const finalDamage = Math.round(damage); redChar.currentHP -= finalDamage; if (redChar.currentHP < 0) redChar.currentHP = 0; log(`é€ æˆæœ€çµ‚å‚·å®³: ${finalDamage} é»ï¼`); log(`${redChar.name} å‰©é¤˜ HP: ${redChar.currentHP}/100`); if (redChar.currentHP <= 0) log(`â˜ ï¸ ${redChar.name} å·²è¢«æ“Šæ•—ï¼`); saveData(); renderAll(); }
    
    // --- Initialization ---
    window.onload = async () => {
        await fetchAllGameData();
        loadData();
        renderAll();
    };
    </script>
</body>
</html>

















