<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>戰術儀表板 v4.1 (穩定版)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&display=swap');
        :root {
            --blue-team: #0984e3; --red-team: #d63031; --bg-dark: #2d3436;
            --panel-bg: #485460; --card-bg: #353b48; --text-light: #dfe6e9; 
            --text-secondary: #b2bec3; --hp-full-color: #2ecc71; --hp-mid-color: #f1c40f; 
            --hp-low-color: #e74c3c; --hp-bg: #273c75; --font-mono: 'Roboto Mono', monospace;
            --card-border-color: #3f4a59; --card-header-bg: #2a333f; --card-section-bg: #21252d;
        }        
        
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background-color: var(--bg-dark); color: var(--text-light); margin: 0; padding: 15px; }
        .dashboard { display: flex; justify-content: space-between; gap: 15px; width: 100%; height: calc(100vh - 30px); }
        .panel { background-color: var(--panel-bg); border-radius: 8px; padding: 15px; overflow-y: auto; }
        .roster-panel { flex: 2; border-top: 5px solid; }
        .roster-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--text-secondary); padding-bottom: 10px; margin-bottom: 15px; }
        .roster-header h3 { margin: 0; font-size: 1.2em; }
        .add-char-btn { background: #27ae60; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer; }
        .clear-data-btn { background: #c0392b; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer; margin-left: 10px; }
        .roster-char { position: relative; display: flex; flex-direction: column; margin-bottom: 10px; padding: 8px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; border: 1px solid transparent; }
        .roster-char.selected { background-color: rgba(255, 255, 255, 0.15); border-color: white; }
        .char-main-info { display: flex; align-items: center; width: 100%; }
        .roster-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px; border: 2px solid var(--text-secondary); }
        .delete-char-btn { position: absolute; top: 5px; right: 5px; background: #c0392b; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; opacity: 0; transition: opacity 0.2s; font-size: 12px; line-height: 20px; text-align: center; }
        .roster-char:hover .delete-char-btn { opacity: 1; }
        .hp-bar-container { width: 100%; background: var(--hp-bg); height: 8px; border-radius: 4px; margin-top: 5px; }
        .hp-bar { height: 100%; border-radius: 4px; transition: width 0.3s ease, background-color 0.3s ease; }
        .active-character-panel { flex: 4; border-top: 5px solid; }
        .active-character-panel .placeholder { text-align: center; margin-top: 40%; color: var(--text-secondary); }
        .card-layout { background: var(--card-bg); border-radius: 8px; padding: 20px; height: 100%; box-sizing: border-box; display: flex; flex-direction: column; border: 2px solid var(--card-border-color); }
        .card-header { display: flex; align-items: center; padding-bottom: 15px; margin-bottom: 15px; border-bottom: 1px solid var(--card-border-color); background-color: var(--card-header-bg); padding: 10px 15px; margin: -20px -20px 15px -20px; border-top-left-radius: 6px; border-top-right-radius: 6px; }
        .card-avatar { width: 100px; height: 100px; border-radius: 8px; object-fit: cover; margin-right: 15px; }
        .card-name-title { flex-grow: 1; }
        .card-name-title input[type=text] { width: 100%; font-size: 1.8em; font-weight: bold; background: transparent; border: none; color: inherit; padding: 2px; }
        .card-name-title input[type=text].title { font-size: 1em; font-style: italic; color: var(--text-secondary); font-weight: normal; }
        .avatar-upload-label { cursor: pointer; font-size: 0.8em; text-decoration: underline; margin-top: 5px; display: inline-block; }
        .card-stats { display: flex; justify-content: space-around; text-align: center; padding: 15px 0; margin-bottom: 15px; border-bottom: 1px solid var(--card-border-color); border-top: 1px solid var(--card-border-color); }
        .stat-box { flex: 1; position: relative; }
        .stat-box:not(:last-child)::after { content: ''; position: absolute; right: 0; top: 10%; height: 80%; width: 1px; background-color: var(--card-border-color); }
        .stat-box label { font-size: 0.8em; color: var(--text-secondary); text-transform: uppercase; }
        .stat-box .value { font-family: var(--font-mono), monospace; font-size: 2.2em; line-height: 1.1; }
        .stat-box .value input { font-family: inherit; font-size: inherit; color: inherit; background: transparent; border: none; text-align: center; width: 100%; padding: 0; }
        .card-body { padding-top: 0; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; flex-grow: 1; }
        .card-section { background-color: var(--card-section-bg); padding: 15px; border-radius: 5px; border: 1px solid var(--card-border-color); }
        .card-section h4 { margin: 0 0 10px 0; border-bottom: 1px solid var(--panel-bg); padding-bottom: 5px; }
        .item-list { list-style: none; padding: 0; }
        .item-list li { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; background: var(--bg-dark); padding: 8px; border-radius: 4px; }
        .item-remove-btn { color: #e74c3c; cursor: pointer; font-weight: bold; }
        .db-selection { display: flex; gap: 10px; margin-top: 10px; }
        .db-selection select { width: 100%; background: var(--bg-dark); color: var(--text-light); border: 1px solid var(--panel-bg); padding: 5px; border-radius: 4px; }
        .db-selection button { padding: 5px 10px; background: #27ae60; color: white; border:none; border-radius: 4px; cursor: pointer; }
        .combat-panel { flex: 3; text-align: center; display: flex; flex-direction: column; justify-content: center; }
        .combat-header { font-size: 1.5em; margin-bottom: 20px; }
        .combatants { display: flex; justify-content: space-around; align-items: center; margin-bottom: 20px; }
        .combatant { display: flex; flex-direction: column; align-items: center; }
        .combatant-avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; }
        #battle-btn { padding: 15px 40px; font-size: 1.5em; background-color: var(--red-team); color: white; border: none; border-radius: 50px; cursor: pointer; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--panel-bg); padding: 25px; border-radius: 8px; width: 90%; max-width: 500px; }
        .modal-content form { display: contents; }
        .modal-content h3 { margin-top: 0; }
        .modal-content .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .modal-content .form-group { margin-bottom: 15px; grid-column: 1 / -1; }
        .modal-content .form-grid .form-group { grid-column: auto; margin-bottom: 0; }
        .modal-content label { display: block; margin-bottom: 5px; }
        .modal-content input, .modal-content select { width: 100%; box-sizing: border-box; padding: 8px; border-radius: 5px; border: 1px solid var(--text-secondary); background: var(--bg-dark); color: var(--text-light); }
        .modal-buttons { text-align: right; margin-top: 15px; grid-column: 1 / -1; }
        .modal-buttons button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        .modal-buttons .save { background-color: #27ae60; color: white; }
        .modal-buttons .cancel { background-color: #7f8c8d; color: white; }
        .team-blue { border-color: var(--blue-team); } .team-red { border-color: var(--red-team); }
        .team-blue .roster-header h3 { color: var(--blue-team); } .team-red .roster-header h3 { color: var(--red-team); }
        .team-blue .card-name-title input[type=text] { color: var(--blue-team); } .team-red .card-name-title input[type=text] { color: var(--red-team); }
        .team-blue .avatar-upload-label { color: var(--blue-team); } .team-red .avatar-upload-label { color: var(--red-team); }
        .stat-row {
            display: flex;
            justify-content: space-around;
            width: 100%;
        }
        .card-stats {
            flex-direction: column; /* 讓兩行數值垂直排列 */
            padding: 0;
            gap: 10px; /* 兩行之間的間距 */
        }
        .proficiency-row {
            border-top: 1px solid var(--card-border-color);
            padding-top: 10px;
        }
        .proficiency-row .value {
            font-size: 1.8em; /* 讓第二行的字小一點，以示區別 */
        }
        .passive-skill-section {
            margin-top: 15px; /* 與上方區塊的間距 */
        }
        .passive-skill-box {
            background: var(--bg-dark);
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .skill-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
        .skill-actions {
          display: flex;
          align-items: center;
          gap: 8px;
          flex-shrink: 0; /* 防止按鈕被壓縮 */
      }
        .skill-use-btn {
          padding: 5px 10px;
          background-color: var(--blue-team);
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
      }
        .skill-use-btn:disabled {
          background-color: var(--text-secondary);
          cursor: not-allowed;
      }
    </style>
</head>
<body>
    <div id="loading-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); color: white; display: flex; justify-content: center; align-items: center; z-index: 2000; font-size: 1.5em;">
        正在從 Google Sheets 載入遊戲規則...
    </div>
    <div class="dashboard">
        <div class="panel roster-panel team-blue"><div class="roster-header"><h3>藍方人員列表</h3><div><button class="add-char-btn" onclick="openAddCharModal('blue')">新增</button><button class="clear-data-btn" onclick="clearTeamData('blue')">清除藍方</button></div></div><div id="roster-blue"></div></div>
        <div class="panel active-character-panel team-blue" id="active-panel-blue"><div class="placeholder">請新增或選擇角色</div></div>
        <div class="panel combat-panel" id="combat-panel"><h2 class="combat-header">交戰模擬</h2><div class="combatants"><div class="combatant"><img id="combatant-avatar-blue" src="https://placehold.co/80x80?text=?" class="combatant-avatar"><h3 id="combatant-name-blue">選擇藍方</h3></div><div> VS </div><div class="combatant"><img id="combatant-avatar-red" src="https://placehold.co/80x80?text=?" class="combatant-avatar"><h3 id="combatant-name-red">選擇紅方</h3></div></div><div class="combat-options" style="margin-bottom: 20px;"><div class="form-group" style="margin-bottom:10px;"><label for="attack-angle">攻擊角度</label><select id="attack-angle" style="padding: 8px; width: 150px; margin:auto;"><option value="front">前方</option><option value="side">側面</option><option value="rear">後方</option></select></div></div><button id="battle-btn" onclick="simulateCombat()">開始戰鬥</button><div id="combat-log" style="margin-top: 20px; text-align: left; background: var(--bg-dark); padding: 10px; border-radius: 5px; max-height: 300px; overflow-y: auto;"><strong>戰鬥記錄:</strong></div></div>
        <div class="panel active-character-panel team-red" id="active-panel-red"><div class="placeholder">請新增或選擇角色</div></div>
        <div class="panel roster-panel team-red"><div class="roster-header"><h3>紅方人員列表</h3><div><button class="add-char-btn" onclick="openAddCharModal('red')">新增</button><button class="clear-data-btn" onclick="clearTeamData('red')">清除紅方</button></div></div><div id="roster-red"></div></div>
    </div>
    <div id="addCharModal" class="modal">
        <div class="modal-content"><form id="addCharForm"><h3 id="modalTitle">新增角色</h3>
<div class="form-group">
    <label for="charIdTemplate">資料庫ID (選填，可自動帶入資訊)</label>
    <input type="text" id="charIdTemplate" placeholder="例如：spec_ops_01">
</div>
            <div class="form-group"><label for="charName">角色名稱</label><input type="text" id="charName" placeholder="例如：王小明"></div><div class="form-group"><label for="charTitle">稱號</label><input type="text" id="charTitle" placeholder="例如：路人甲"></div><div class="form-grid">
    <div class="form-group"><label for="charMobility">機動 (MOVE)</label><input type="number" id="charMobility" value="5"></div>
    <div class="form-group"><label for="charStrength">肌力 (STR)</label><input type="number" id="charStrength" value="15"></div>
    <div class="form-group"><label for="charPrimaryProf">主武器熟稔</label>
        <select id="charPrimaryProf">
            <option value="S">S</option><option value="A">A</option><option value="B" selected>B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option>
        </select>
    </div>
    <div class="form-group"><label for="charSecondaryProf">副武器熟稔</label>
         <select id="charSecondaryProf">
            <option value="S">S</option><option value="A">A</option><option value="B">B</option><option value="C" selected>C</option><option value="D">D</option><option value="E">E</option>
        </select>
    </div>
    <div class="form-group"><label for="charBreachingProf">破門工具熟稔</label>
         <select id="charBreachingProf">
            <option value="S">S</option><option value="A">A</option><option value="B">B</option><option value="C" selected>C</option><option value="D">D</option><option value="E">E</option>
        </select>
    </div>
    <div class="form-group"><label for="charSpecialProf">特殊裝備熟稔</label>
         <select id="charSpecialProf">
            <option value="S">S</option><option value="A">A</option><option value="B">B</option><option value="C" selected>C</option><option value="D">D</option><option value="E">E</option>
        </select>
    </div>
</div>
    <div class="modal-buttons"><button type="button" class="cancel" onclick="close()">取消</button><button type="submit" class="save" id="saveCharBtn">儲存</button></div></form></div>
    </div>

    <script>
    // --- Databases (will be populated from Google Sheets) ---
    let WEAPON_DB = {};
    let GEAR_DB = {};
    let SKILL_DB = {};
    let characterTemplateDB = {};

    const PROFICIENCY_MODIFIERS = { 'S': 1.05, 'A': 1.0, 'B': 0.95, 'C': 0.9, 'D': 0.85, 'E': 0.8 };
    
    // --- Application State ---
    let gameState = { characters: { blue: [], red: [] }, selectedChar: { blue: null, red: null }, combatants: { blue: null, red: null } };

    // --- Core Functions ---
    async function fetchAllGameData() {
        const loadingOverlay = document.getElementById('loading-overlay');
        loadingOverlay.textContent = '正在從 Google Sheets 載入遊戲規則...';
        loadingOverlay.style.display = 'flex';

        const urls = {
            // !!! 請務必將下方四個網址替換為您自己的 Google Sheet CSV 發佈網址 !!!
            characters: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTQyn3ID7LBfpRjYBuX1mLweeQ1sr7thV4WHMiG5AqiqURFJftxuJ2z_8XXNPL8yIt7avYq8xfmPv09/pub?gid=0&single=true&output=csv',
            weapons: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSUgRC-c-_jUmGAF6CJn3P057w0bc43uWBTnmPbEVUSSPa4GlWqudaM7HY3Oc_NIgI9L_mPEai3weRS/pub?gid=619091591&single=true&output=csv',
            gear: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRhpFeTps4MlzO_sRZbABh_YhjmNngDRfYUjoyfJm7KqEemObopE9RQ_V30C8ZWgvclRBUuqcU5BVOI/pub?gid=2032212675&single=true&output=csv',
            skills: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTW3fGuzaVQXHxPg32SG3qhUBmuL_uJTTEqx8HrcT7ZtQVmIN6623OR5bZPooGiizHOIEAEoBQQkHCl/pub?gid=1620707329&single=true&output=csv'
        };

        try {
            const responses = await Promise.all([
                fetch(urls.characters).then(res => res.text()), fetch(urls.weapons).then(res => res.text()),
                fetch(urls.gear).then(res => res.text()), fetch(urls.skills).then(res => res.text())
            ]);
            const [charCsv, weaponCsv, gearCsv, skillCsv] = responses;

            // Simple Parsing Logic
            characterTemplateDB = {};
            const charRows = charCsv.split('\n').slice(1);
            charRows.forEach((row, index) => {
                if (!row.trim()) return;
                const cols = row.trim().split(',');
                if (cols.length < 10) throw new Error(`第 ${index + 2} 行欄位數不足 (應為10，實際為${cols.length})`);
                const t = { 
                    id: cols[0], name: cols[1], title: cols[2], 
                    stats: { mobility: parseInt(cols[3]), strength: parseInt(cols[4]) }, 
                    primary_proficiency: cols[5], 
                    secondary_proficiency: cols[6],
                    breaching_proficiency: cols[7],
                    special_proficiency: cols[8],
                    passive_skill_id: cols[9].trim()
                };
                characterTemplateDB[t.id] = t;
            });
            WEAPON_DB = {};
            weaponCsv.split('\n').slice(1).forEach(row => {
                if (!row.trim()) return; const cols = row.trim().split(','); if (cols.length < 9) return;
                const effectsString = cols[9] ? cols[9].trim() : '[]';
                WEAPON_DB[cols[0]] = { name: cols[1], weight: parseInt(cols[2]), type: cols[3], ammo_type: cols[4], base_damage: parseInt(cols[5]), accuracy_short: parseInt(cols[6]), accuracy_mid: parseInt(cols[7]), accuracy_long: parseInt(cols[8]), effects: JSON.parse(effectsString) };
            });
            GEAR_DB = {};
            gearCsv.split('\n').slice(1).forEach(row => {
                if (!row.trim()) return; const cols = row.trim().split(','); if (cols.length < 10) return;
                const effectsString = cols[10] ? cols[10].trim() : '[]';
                GEAR_DB[cols[0]] = { name: cols[1], weight: parseInt(cols[2]), gear_type: cols[3], mobility_penalty: parseInt(cols[4]), coverage_front: parseInt(cols[5]), coverage_side: parseInt(cols[6]), coverage_rear: parseInt(cols[7]), durability: parseInt(cols[8]), armor_level: cols[9], effects: JSON.parse(effectsString) };
            });
            SKILL_DB = {};
            const skillRows = skillCsv.split('\n').slice(1);
            skillRows.forEach((row, index) => {
                if (!row.trim()) return;
                const cols = row.trim().split(',');
                if (cols.length < 5) throw new Error(`第 ${index + 2} 行欄位數不足 (應至少5欄)`);
                const effectsString = cols[5] ? cols[5].trim() : '[]';
                SKILL_DB[cols[0]] = { 
                    name: cols[1], 
                    type: cols[2], 
                    desc: cols[3], 
                    uses: parseInt(cols[4]), 
                    effects: JSON.parse(effectsString) 
                };
            });

            console.log('所有遊戲資料已成功載入！');
            loadingOverlay.style.display = 'none';
        } catch (error) {
            console.error('載入或解析遊戲資料時發生錯誤:', error);
            loadingOverlay.textContent = `載入失敗！請按F12檢查主控台錯誤訊息。`;
        }
    }
    
    function saveData() { localStorage.setItem('tacticalDashboardData_v4.1', JSON.stringify(gameState.characters)); }
    function loadData() {
        const data = localStorage.getItem('tacticalDashboardData_v4.1');
        if (data) gameState.characters = JSON.parse(data);
    }
    function clearTeamData(team) { const teamName = team === 'blue' ? '藍方' : '紅方'; if (confirm(`確定要清除所有${teamName}的角色資料嗎？此操作無法復原！`)) { gameState.characters[team] = []; gameState.selectedChar[team] = null; gameState.combatants[team] = null; saveData(); renderAll(); } }
    function renderAll() { ['blue', 'red'].forEach(team => { renderRoster(team); const selectedId = gameState.selectedChar[team]; if (selectedId && gameState.characters[team].some(c => c.id === selectedId)) { displayCharacterDetails(selectedId, team); } else if (gameState.characters[team].length > 0) { gameState.selectedChar[team] = gameState.characters[team][0].id; renderRoster(team); displayCharacterDetails(gameState.selectedChar[team], team); } else { document.getElementById(`active-panel-${team}`).innerHTML = `<div class="placeholder">請新增或選擇角色</div>`; } }); updateCombatPanel(); }
    function renderRoster(team) { const rosterContainer = document.getElementById(`roster-${team}`); rosterContainer.innerHTML = ''; gameState.characters[team].forEach(char => { const charDiv = document.createElement('div'); charDiv.className = 'roster-char'; if (gameState.selectedChar[team] === char.id) charDiv.classList.add('selected'); charDiv.onclick = () => { gameState.selectedChar[team] = char.id; renderAll(); }; const hpPercent = (char.currentHP / 100) * 100; let hpBarColor = `var(--hp-full-color)`; if (hpPercent < 70) hpBarColor = `var(--hp-mid-color)`; if (hpPercent < 30) hpBarColor = `var(--hp-low-color)`; charDiv.innerHTML = ` <div class="char-main-info"> <img src="${char.avatar}" class="roster-avatar"> <span>${char.name}</span> </div> <div class="hp-bar-container"><div class="hp-bar" style="width: ${hpPercent}%; background-color: ${hpBarColor};"></div></div> <button class="delete-char-btn" onclick="event.stopPropagation(); deleteCharacter('${char.id}', '${team}')">✕</button> `; rosterContainer.appendChild(charDiv); }); }
    function addCharacter(team, event) {
    event.preventDefault();
    const templateId = document.getElementById('charIdTemplate').value;
    const template = characterTemplateDB[templateId]; 
        
    const newChar = {
        id: 'char_' + Date.now(),
        name: document.getElementById('charName').value || '新兵',
        title: document.getElementById('charTitle').value || '無名小卒',
        maxHP: 100, 
        currentHP: 100,
        stats: {
            mobility: parseInt(document.getElementById('charMobility').value) || 5,
            strength: parseInt(document.getElementById('charStrength').value) || 15,
        },
        primary_proficiency: document.getElementById('charPrimaryProf').value,
        secondary_proficiency: document.getElementById('charSecondaryProf').value,
        breaching_proficiency: document.getElementById('charBreachingProf').value,
        special_proficiency: document.getElementById('charSpecialProf').value,
        passive_skill_id: template ? template.passive_skill_id : null, 
        avatar: 'https://placehold.co/100x100?text=?', 
        equipment: [], 
        skills: [], 
        skillCharges: {} 
    };
    
    gameState.characters[team].push(newChar);
    gameState.selectedChar[team] = newChar.id;
    closeAddCharModal(); 
    saveData(); 
    renderAll();
}
    function deleteCharacter(charId, team) { if (!confirm('確定要刪除此角色嗎？')) return; const index = gameState.characters[team].findIndex(c => c.id === charId); if (index > -1) { gameState.characters[team].splice(index, 1); if(gameState.selectedChar[team] === charId) gameState.selectedChar[team] = null; if(gameState.combatants[team] === charId) gameState.combatants[team] = null; saveData(); renderAll(); } }
    function displayCharacterDetails(charId, team) {
    const char = gameState.characters[team].find(c => c.id === charId);
    const panel = document.getElementById(`active-panel-${team}`);
    if (!char) { panel.innerHTML = `<div class="placeholder">角色不存在</div>`; return; }

    let totalWeight = 0;
    char.equipment.forEach(itemId => { const item = WEAPON_DB[itemId] || GEAR_DB[itemId]; if (item) totalWeight += item.weight; });
    
    const activeSkillOptions = Object.keys(SKILL_DB).filter(id => SKILL_DB[id].type === 'active').map(id => `<option value="${id}">${SKILL_DB[id].name}</option>`).join('');
    const weaponOptions = Object.keys(WEAPON_DB).map(id => `<option value="${id}">${WEAPON_DB[id].name}</option>`).join('');
    const gearOptions = Object.keys(GEAR_DB).map(id => `<option value="${id}">${GEAR_DB[id].name}</option>`).join('');
    
    const passiveSkill = SKILL_DB[char.passive_skill_id];
    let passiveSkillHTML = `<h4>固有被動技能 (Passive)</h4><div class="passive-skill-box">無</div>`;
    if (passiveSkill) {
        passiveSkillHTML = `
            <h4>固有被動技能 (Passive)</h4>
            <div class="passive-skill-box">
                <strong>${passiveSkill.name}</strong><br>
                <small style="color: var(--text-secondary);">${passiveSkill.desc}</small>
            </div>
        `;
    }
    
    // 【新增】檢查主動技能數量是否已達上限
    const isSkillSlotFull = char.skills.length >= 2;

    panel.innerHTML = `
        <div class="card-layout">
            <div class="card-header">
                <img src="${char.avatar}" class="card-avatar" id="avatar-${team}-${charId}">
                <div class="card-name-title">
                    <input type="text" value="${char.name}" onchange="updateCharValue('${char.id}', '${team}', 'name', this.value)">
                    <input type="text" class="title" value="${char.title}" onchange="updateCharValue('${char.id}', '${team}', 'title', this.value)">
                    <label class="avatar-upload-label">更換頭像 <input type="file" onchange="handleAvatarUpload(event, '${char.id}', '${team}')" accept="image/*" style="display:none;"></label>
                </div>
            </div>
            <div class="card-stats">
                <div class="stat-row"><div class="stat-box"> <label>HP</label> <div class="value"><input type="number" value="${char.currentHP}" onchange="updateCharValue('${char.id}', '${team}', 'currentHP', this.value)"></div> </div><div class="stat-box"> <label>MOVE</label> <div class="value">${char.stats.mobility}</div> </div><div class="stat-box"> <label>STRENGTH</label> <div class="value">${char.stats.strength}</div> </div><div class="stat-box"> <label>WEIGHT</label> <div class="value">${totalWeight}</div> </div></div>
                <div class="stat-row proficiency-row"><div class="stat-box"> <label>PRIMARY</label> <div class="value">${char.primary_proficiency}</div> </div><div class="stat-box"> <label>SECONDARY</label> <div class="value">${char.secondary_proficiency}</div> </div><div class="stat-box"> <label>BREACHING</label> <div class="value">${char.breaching_proficiency}</div> </div><div class="stat-box"> <label>SPECIAL</label> <div class="value">${char.special_proficiency}</div> </div></div>
            </div>
            <div class="card-body">
                <div class="card-section">
                    <h4>裝備 (Equipment)</h4>
                    <ul class="item-list">${char.equipment.map(id => { const item = WEAPON_DB[id] || GEAR_DB[id]; if(!item) return ''; return `<li><div><strong>${item.name}</strong> (+${item.weight} WU)${formatEffects(item)}</div><span class="item-remove-btn" onclick="removeItem('${char.id}','${team}','equipment','${id}')">✕</span></li>`; }).join('')}</ul>
                    <div class="db-selection"> <select id="equip-select-${team}"><optgroup label="武器">${weaponOptions}</optgroup><optgroup label="配件">${gearOptions}</optgroup></select> <button onclick="addItem('${char.id}','${team}','equipment','equip-select-${team}')">添加</button> </div>
                </div>
                <div class="card-section">
                    <h4>主動技能 (Active)</h4>
                    <ul class="item-list">
                        ${char.skills.map(id => {
                            const skill = SKILL_DB[id];
                            if (!skill) return '';
                            if (char.skillCharges[id] === undefined) { char.skillCharges[id] = skill.uses; }
                            const remainingUses = char.skillCharges[id];
                            const buttonDisabled = remainingUses <= 0 ? 'disabled' : '';
                            return `
                                <li class="skill-item">
                                    <div>
                                        <strong>${skill.name}</strong><br>
                                        <small style="color: var(--text-secondary);">${skill.desc}</small>
                                    </div>
                                    <div class="skill-actions">
                                        <span class="skill-uses">(${remainingUses}/${skill.uses})</span>
                                        <button class="skill-use-btn" onclick="activateSkill('${char.id}', '${team}', '${id}')" ${buttonDisabled}>使用</button>
                                        <span class="item-remove-btn" onclick="removeItem('${char.id}','${team}','skills','${id}')">✕</span>
                                    </div>
                                </li>`;
                        }).join('')}
                    </ul>
                    <div class="db-selection">
                        <select id="skill-select-${team}" ${isSkillSlotFull ? 'disabled' : ''}>${activeSkillOptions}</select>
                        <button onclick="addItem('${char.id}','${team}','skills','skill-select-${team}')" ${isSkillSlotFull ? 'disabled' : ''}>添加</button>
                    </div>
                </div>
            </div>
            <div class="card-section passive-skill-section">
                ${passiveSkillHTML}
            </div>
            <div style="text-align: center; margin-top: auto;"><button class="add-char-btn" onclick="selectCombatant('${char.id}', '${team}')">選為戰鬥單位</button></div>
        </div>
    `;
}
    function handleAvatarUpload(event, charId, team) { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { const char = gameState.characters[team].find(c => c.id === charId); if (char) { char.avatar = e.target.result; saveData(); renderAll(); } }; reader.readAsDataURL(file); } }
    function updateCharValue(charId, team, key, value) { const char = gameState.characters[team].find(c => c.id === charId); if (!char) return; const keys = key.split('.'); let obj = char; for (let i = 0; i < keys.length - 1; i++) { obj = obj[keys[i]]; } let finalValue = typeof obj[keys[keys.length - 1]] === 'number' ? parseInt(value) : value; obj[keys[keys.length - 1]] = finalValue; if (key === 'currentHP') { if (char.currentHP > 100) char.currentHP = 100; if (char.currentHP < 0) char.currentHP = 0; } saveData(); renderAll(); }
    function addItem(charId, team, itemType, selectId) {
    const char = gameState.characters[team].find(c => c.id === charId);
    if (!char) return;

    // 【新增】檢查技能數量上限
    if (itemType === 'skills' && char.skills.length >= 2) {
        alert('主動技能最多只能選擇兩個！');
        return; // 中斷函式執行
    }

    const select = document.getElementById(selectId);
    const itemId = select.value;
    if (char && !char[itemType].includes(itemId)) {
        char[itemType].push(itemId);
        saveData();
        renderAll();
    }
}
    function removeItem(charId, team, itemType, itemId) { const char = gameState.characters[team].find(c => c.id === charId); if (char) { const index = char[itemType].indexOf(itemId); if (index > -1) { char[itemType].splice(index, 1); saveData(); renderAll(); } } }
    function openAddCharModal(team) {
    const modal = document.getElementById('addCharModal');
    const form = document.getElementById('addCharForm');
    form.reset();
    modal.style.display = 'flex';
    document.getElementById('modalTitle').textContent = `新增 ${team === 'blue' ? '藍方' : '紅方'} 角色`;

    const idInput = document.getElementById('charIdTemplate');
    
    // 當 ID 輸入框失去焦點時觸發
    idInput.onblur = () => {
        const enteredId = idInput.value;
        const template = characterTemplateDB[enteredId];
        
        if (template) {
            // 如果在資料庫中找到該角色，自動填入所有相關欄位
            document.getElementById('charName').value = template.name;
            document.getElementById('charTitle').value = template.title;
            document.getElementById('charMobility').value = template.stats.mobility;
            document.getElementById('charStrength').value = template.stats.strength;
            document.getElementById('charPrimaryProf').value = template.primary_proficiency;
            document.getElementById('charSecondaryProf').value = template.secondary_proficiency;
            document.getElementById('charBreachingProf').value = template.breaching_proficiency;
            document.getElementById('charSpecialProf').value = template.special_proficiency;
        }
    };
    
    form.onsubmit = (event) => addCharacter(team, event);
}
    function closeAddCharModal() { document.getElementById('addCharModal').style.display = 'none'; }
    function formatEffects(item) { if (!item.effects || item.effects.length === 0) return ''; const effectStrings = item.effects.map(effect => { if (effect.stat) { let statName = effect.stat; if (statName === 'maxHP') statName = '最大HP'; if (statName === 'mobility') statName = '機動'; if (statName === 'strength_calculation') statName = '肌力(計算用)'; if (statName === 'accuracy_short') statName = '近距離命中'; if (statName === 'crit_chance') statName = '暴擊率'; if (statName === 'crit_damage') statName = '暴擊傷害'; return `${statName} ${effect.modifier}${effect.value}`; } if (effect.effect === 'apply_status') { return `有 ${effect.chance * 100}% 機率附加【${effect.status}】狀態`; } return '特殊效果'; }); return `<br><small style="color: var(--text-secondary);">效果: ${effectStrings.join(' / ')}</small>`; }
    function selectCombatant(charId, team) { const char = gameState.characters[team].find(c => c.id === charId); if (char) { gameState.combatants[team] = charId; updateCombatPanel(); } }
    function updateCombatPanel() { const blueChar = gameState.characters['blue'].find(c => c.id === gameState.combatants['blue']); const redChar = gameState.characters['red'].find(c => c.id === gameState.combatants['red']); document.getElementById('combatant-name-blue').textContent = blueChar ? blueChar.name : '選擇藍方'; document.getElementById('combatant-avatar-blue').src = blueChar ? blueChar.avatar : 'https://placehold.co/80x80?text=?'; document.getElementById('combatant-name-red').textContent = redChar ? redChar.name : '選擇紅方'; document.getElementById('combatant-avatar-red').src = redChar ? redChar.avatar : 'https://placehold.co/80x80?text=?'; }
    function activateSkill(charId, team, skillId) {
    const char = gameState.characters[team].find(c => c.id === charId);
    const skill = SKILL_DB[skillId];
    if (!char || !skill || char.skillCharges[skillId] <= 0) {
        return; 
    }

    char.skillCharges[skillId]--;

    console.log(`角色 ${char.name} 使用了技能 [${skill.name}]！`);
    console.log("技能效果 (effects):", skill.effects);
    console.log("下一步：我們需要在 simulateCombat 中加入邏輯來實際套用這些效果。");
    
    saveData();
    renderAll();
}
    function simulateCombat() { const blueChar = gameState.characters['blue'].find(c => c.id === gameState.combatants['blue']); const redChar = gameState.characters['red'].find(c => c.id === gameState.combatants['red']); const combatLog = document.getElementById('combat-log'); combatLog.innerHTML = '<strong>戰鬥記錄:</strong><br>'; if (!blueChar || !redChar) { combatLog.innerHTML += `<p style="color:red;">請確保雙方都已選擇戰鬥單位！</p>`; return; } const log = (message) => { combatLog.innerHTML += `<p>${message}</p>`; combatLog.scrollTop = combatLog.scrollHeight;}; log(`>>> ${blueChar.name} 對 ${redChar.name} 發動攻擊！`); const weapon = blueChar.equipment.map(id => WEAPON_DB[id]).find(item => item && item.type === 'primary'); if (!weapon) { log(`❌ ${blueChar.name} 沒有裝備主武器！`); return; } const proficiencyKey = weapon.type === 'primary' ? 'primary_proficiency' : 'secondary_proficiency'; const proficiencyLevel = blueChar[proficiencyKey] || 'E'; const proficiencyMod = PROFICIENCY_MODIFIERS[proficiencyLevel] || 0.8; let baseAccuracy = weapon.accuracy_mid; let finalBaseDamage = weapon.base_damage * proficiencyMod; log(`武器熟稔度(${proficiencyLevel}): 效率 ${proficiencyMod * 100}%`); let passiveBonuses = { accuracy: 0, damage: 0, crit_chance: 0, crit_damage: 0 }; blueChar.equipment.forEach(id => { const item = GEAR_DB[id]; if (item && item.effects) { item.effects.forEach(effect => { if(effect.stat && effect.stat.includes('accuracy')) { passiveBonuses.accuracy += effect.value; log(`⚡ 來自 [${item.name}] 的加成: 命中 +${effect.value}`); } }); } }); const finalBaseAccuracy = (baseAccuracy + passiveBonuses.accuracy) * proficiencyMod; const finalHitChance = finalBaseAccuracy; const hitRoll = Math.floor(Math.random() * 100) + 1; log(`擲骰判定命中 (d100 <= ${finalHitChance.toFixed(0)})... 結果: ${hitRoll}`); if (hitRoll > finalHitChance) { log(`💥 MISS!! 攻擊失手！`); return; } log(`✔️ 初步命中！進入護甲判定...`); const attackAngle = document.getElementById('attack-angle').value; const coverageKey = `coverage_${attackAngle}`; let highestCoverage = 0, blockingArmorId = null; redChar.equipment.forEach(id => { const item = GEAR_DB[id]; if (item && (item.gear_type === 'armor' || item.gear_type === 'shield') && item[coverageKey] > highestCoverage) { highestCoverage = item[coverageKey]; blockingArmorId = id; } }); if (highestCoverage > 0) { const blockRoll = Math.floor(Math.random() * 100) + 1; log(`防禦方 ${attackAngle} 方向防禦率為 ${highestCoverage}%`); log(`擲骰判定格擋 (d100 <= ${highestCoverage})... 結果: ${blockRoll}`); if (blockRoll <= highestCoverage) { const blockingArmor = GEAR_DB[blockingArmorId]; log(`🛡️ 被擋下了!! 攻擊被 ${blockingArmor.name} 阻擋！`); blockingArmor.durability -= 1; log(`${blockingArmor.name} 耐久度剩餘 ${blockingArmor.durability}`); if(blockingArmor.durability <= 0) log(`⚠️ ${blockingArmor.name} 已失效！`); saveData(); renderAll(); return; } } log(`🩸 攻擊穿透防禦，命中肉身！`); const variance = (Math.random() * 0.10) - 0.05; let damage = finalBaseDamage * (1 + variance); log(`計算基礎傷害... ${finalBaseDamage.toFixed(1)} * (1 ${variance > 0 ? '+' : ''} ${variance.toFixed(2)}) = ${damage.toFixed(1)}`); const critChance = 5 + passiveBonuses.crit_chance; const critRoll = Math.floor(Math.random() * 100) + 1; log(`擲骰判定暴擊 (d100 >= ${101 - critChance})... 結果: ${critRoll}`); if (critRoll >= (101 - critChance)) { const critBonus = 0.05 + (passiveBonuses.crit_damage / 100); const extraDamage = damage * critBonus; damage += extraDamage; log(`💥 CRITICAL HIT!! 額外造成 ${extraDamage.toFixed(1)} 傷害！`); } const finalDamage = Math.round(damage); redChar.currentHP -= finalDamage; if (redChar.currentHP < 0) redChar.currentHP = 0; log(`造成最終傷害: ${finalDamage} 點！`); log(`${redChar.name} 剩餘 HP: ${redChar.currentHP}/100`); if (redChar.currentHP <= 0) log(`☠️ ${redChar.name} 已被擊敗！`); saveData(); renderAll(); }
    
    // --- Initialization ---
    window.onload = async () => {
        await fetchAllGameData();
        loadData();
        renderAll();
    };
    </script>
</body>
</html>

















